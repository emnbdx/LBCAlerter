@model IEnumerable<LBCAlerterWeb.Models.Search>
@{
    ViewBag.Title = "Nouvelle alerte";
    ViewBag.Current = "new";
    ViewBag.Large = true;
}

<!-- page header -->
<div class="pageheader">
    <h2>
        <i class="fa fa-edit"></i> Nouvelle alerte
    </h2>
    <div class="breadcrumbs">
        <ol class="breadcrumb">
            <li>Vous êtes ici</li>
            <li><a href="@Url.Action("Index", "Search")">LBC Alerter</a></li>
            <li class="active">Nouvelle alerte</li>
        </ol>
    </div>
</div>
<!-- /page header -->

    @if (Model.Count() >= 5 && !Roles.IsUserInRole("admin") && !Roles.IsUserInRole("premium"))
    {
        <p style="color: red;">
            Il vous faut un compte premium pour ajouter plus de 5 recherches.<br />
            Un compte premium s'obtient en faisant un don du montant que vous voulez.<br/>
            @Html.ActionLink("Soyez sympa !", "Create", "Don")
        </p>
    }
    else
    {
        <div id="iframeContainer">
            <iframe id="firstPage" srcdoc="@LBCMapping.HtmlParser.GetHomePage()"></iframe>
        </div>
    }

    <div class="links">
        @Html.ActionLink("Retour à la liste", "Index")
    </div>

@section Scripts {
    <script type="text/javascript">
        function showSecondPage(link) {
            $.ajax({
                url: '@Url.Action("DisplaySecondPage", "Search")',
                type: 'POST',
                data: { url: link },
                success: function (data) {
                    $('<iframe />', {
                        name: 'secondPage',
                        id: 'secondPage',
                        style: 'width: 100%; height: 330px;',
                        srcdoc: data["html"].replace('window.location.href', 'var searchUrl')
                            .replace('return false;',
                            'if(searchUrl.indexOf("&q=") == -1) ' +
                            '   if(!confirm("Attention vous n\'avez pas spécifié de mots clé, est-ce volontaire ?")) ' +
                            '       return false; ' +
                            '$.ajax({ ' +
                            '   url: \'@Url.Action("Create", "Search")\', ' +
                            '   type: \'POST\', ' +
                            '   data: { ' +
                            '       Url: searchUrl, ' +
                            '       RefreshTime: 15, ' +
                            '       MailAlert: true, ' +
                            '       MailRecap: false, ' +
                            '   }, ' +
                            '   success: function (data) { ' +
                            '       if(!data["success"]) ' +
                            '          alert(data["message"]); ' +
                            '       else ' +
                            '           alert(\'Votre recherche a bien été crée vous allez recevoir 5 mails correspondants aux dernières annonces parues.\'); ' + 
                            '       window.top.location.href = \'@Url.Action("Index", "Search")\'; ' +
                            '   } ' +
                            '}); ' +
                            'return false;')
                    }).appendTo('#iframeContainer');
                }
            });
        }

        $('#firstPage').load(function () {
            $(this).contents().find("area").click(function (event) {
                $('#firstPage').hide();
                showSecondPage($(this).attr('href'));
            });
        });

        $('#firstPage').load(function () {
            $(this).contents().find("a").click(function (event) {
                $('#firstPage').hide();
                showSecondPage($(this).attr('href'));
            });
        });
    </script>
}