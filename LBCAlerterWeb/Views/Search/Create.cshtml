@model IEnumerable<LBCAlerterWeb.Models.Search>
@{
    ViewBag.Title = "Ajouter";
    Layout = "~/Views/Shared/_PrettyLayout.cshtml";
}

<!-- page header -->
<div class="pageheader">
    <h2>
        <i class="fa fa-edit"></i> Ajout d'une alerte
    </h2>
    <div class="breadcrumbs">
        <ol class="breadcrumb">
            <li>You are here</li>
            <li><a href="@Url.Action("Index", "Search")">LBC Alerter</a></li>
            <li class="active">Nouvelle alerte</li>
        </ol>
    </div>
</div>
<!-- /page header -->

@using (Html.BeginForm())
{
    if (Model.Count() >= 5 && !Roles.IsUserInRole("admin") && !Roles.IsUserInRole("premium"))
    {
        <p style="color: red;">
            Version beta, limité à cinq alertes<br />
        </p>
        <!--<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
            <input type="hidden" name="cmd" value="_s-xclick">
            <input type="hidden" name="hosted_button_id" value="N6SJGHGSKKX4S">
            <input type="image" src="https://www.paypalobjects.com/fr_FR/FR/i/btn/btn_donate_SM.gif" border="0" name="submit" alt="PayPal - la solution de paiement en ligne la plus simple et la plus sécurisée !">
            <img alt="" border="0" src="https://www.paypalobjects.com/fr_FR/i/scr/pixel.gif" width="1" height="1">
        </form>-->
    }
    else
    {
        <div id="iframeContainer">
            <iframe id="firstPage" srcdoc="@LBCMapping.HtmlParser.GetHomePage()"></iframe>
        </div>
    }

    <div class="links">
        @Html.ActionLink("Retour à la liste", "Index")
    </div>
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">
        $('.menu li').each(function () {
            $(this).removeClass('active');
        });

        $('#new').addClass('active');
    </script>

    <script type="text/javascript">
        function showSecondPage(link) {
            $.ajax({
                url: '@Url.Action("DisplaySecondPage", "Search")',
                type: 'POST',
                data: { url: link },
                success: function (data) {
                    $('<iframe />', {
                        name: 'secondPage',
                        id: 'secondPage',
                        style: 'width: 100%; height: 330px;',
                        srcdoc: data["html"].replace('window.location.href', 'var searchUrl')
                            .replace('return false;',
                            'if(searchUrl.indexOf("&q=") == -1) ' +
                            '   if(!confirm("Attention vous n\'avez pas spécifié de mots clé, est-ce volontaire ?")) ' +
                            '       return false; ' +
                            '$.ajax({ ' +
                            '   url: \'@Url.Action("Create", "Search")\', ' +
                            '   type: \'POST\', ' +
                            '   data: { ' +
                            '       Url: searchUrl, ' +
                            '       RefreshTime: 15, ' +
                            '       MailAlert: true, ' +
                            '       MailRecap: false, ' +
                            '   }, ' +
                            '   success: function (data) { ' +
                            '       if(!data["success"]) ' +
                            '          alert(data["message"]); ' +
                            '       else ' +
                            '           alert(\'Votre recherche a bien été crée vous allez recevoir 5 mails correspondants aux dernières annonces parues.\'); ' + 
                            '       window.top.location.href = \'@Url.Action("Index", "Search")\'; ' +
                            '   } ' +
                            '}); ' +
                            'return false;')
                    }).appendTo('#iframeContainer');
                }
            });
        }

        $('#firstPage').load(function () {
            $(this).contents().find("area").click(function (event) {
                $('#firstPage').hide();
                showSecondPage($(this).attr('href'));
            });
        });

        $('#firstPage').load(function () {
            $(this).contents().find("a").click(function (event) {
                $('#firstPage').hide();
                showSecondPage($(this).attr('href'));
            });
        });
    </script>
}